# HASS.Agent Release Build Workflow
#
# This workflow builds, signs, and packages HASS.Agent for release.
#
# Code Signing: Uses Azure Trusted Signing
# Required secrets in ReleaseBuildEnv environment:
#   - AZURE_TENANT_ID
#   - AZURE_CLIENT_ID
#   - AZURE_CLIENT_SECRET
#   - TRUSTED_SIGNING_ENDPOINT
#   - TRUSTED_SIGNING_ACCOUNT
#   - TRUSTED_SIGNING_PROFILE
#
# If signing secrets are not configured, the build will still succeed
# but the installer will be unsigned (users will see SmartScreen warnings).

name: Create Release

on:
  workflow_dispatch:
    inputs:
      sourcebranch:
        description: 'Source branch'
        required: true
        default: 'main'
      releasetitle:
        description: 'Release name'
        required: true
      releasetag:
        description: "Release tag"
        required: true
      prerelease:
        description: 'Is this a pre-release?'
        required: true
        default: 'true'
  #push:
  #  branches: [ "main" ]
  #  tags:
  #  - '*'
  #pull_request:
  #  branches: [ "main" ]

jobs:
  build:
    environment: ReleaseBuildEnv
    strategy:
      matrix:
        #configuration: [Debug, Release]
        configuration: [Release]

    runs-on: windows-latest  # For a list of available runner types, refer to
                             # https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on

    env:
      Solution_Name: src/HASS.Agent.sln                          # Replace with your solution name, i.e. MyWpfApp.sln.
      #Test_Project_Path: your-test-project-path                 # Replace with the path to your test project, i.e. MyWpfApp.Tests\MyWpfApp.Tests.csproj.
      #Wap_Project_Directory: your-wap-project-directory-name    # Replace with the Wap project directory relative to the solution, i.e. MyWpfApp.Package.
      #Wap_Project_Path: your-wap-project-path                   # Replace with the path to your Wap project, i.e. MyWpf.App.Package\MyWpfApp.Package.wapproj.

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.sourcebranch }}

    # Install the .NET workload
    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    # Add  MSBuild to the PATH: https://github.com/microsoft/setup-msbuild
    #- name: Setup MSBuild.exe
    #  uses: microsoft/setup-msbuild@v1.3.1
    
    # Execute all unit tests in the solution
    #- name: Execute unit tests
    #  run: dotnet test

    # Restore the application to populate the obj folder with RuntimeIdentifiers
    #- name: Restore the Nuget Packages
    #  run: |
    #    nuget restore src/HASS.Agent.sln
    #    msbuild src/HASS.Agent.sln #/t:Restore /p:Configuration=$env:Configuration
      #env:
      #  Configuration: ${{ matrix.configuration }}       

    - name: Restore / Install dependencies
      run: |
        dotnet restore "src\\HASS.Agent\\HASS.Agent\\HASS.Agent.csproj"
        dotnet restore "src\\HASS.Agent\\HASS.Agent.Satellite.Service\\HASS.Agent.Satellite.Service.csproj"
    
    - name: Build & Publish HASS.Agent
      working-directory: "D:\\a\\HASS.Agent\\HASS.Agent\\src\\HASS.Agent\\HASS.Agent"
      run: "dotnet publish -c Release -f net10.0-windows10.0.19041.0 -o bin\\Publish-x64\\Release\\ --no-self-contained -r win-x64 -p:Platform=x64"
   
    - name: Build & Publish HASS.Agent.Satellite.Service
      working-directory: "D:\\a\\HASS.Agent\\HASS.Agent\\src\\HASS.Agent\\HASS.Agent.Satellite.Service"
      run: "dotnet publish -c Release -f net10.0-windows10.0.19041.0 -o bin\\Publish-x64\\Release\\ --no-self-contained -r win-x64 -p:Platform=x64"

    - name: Compile InnoSetup Installer - Satellite Service
      working-directory: "D:\\a\\HASS.Agent\\HASS.Agent\\src\\HASS.Agent.Installer"
      run: |
        & "${Env:ProgramFiles(x86)}\\Inno Setup 6\\iscc.exe" InstallerScript-Service.iss

    - name: Compile InnoSetup Installer - Client
      working-directory: "D:\\a\\HASS.Agent\\HASS.Agent\\src\\HASS.Agent.Installer"
      run: |
        & "${Env:ProgramFiles(x86)}\\Inno Setup 6\\iscc.exe" InstallerScript.iss

    - name: Check if signing secrets are available
      id: check-signing
      shell: pwsh
      run: |
        $hasEndpoint = '${{ secrets.TRUSTED_SIGNING_ENDPOINT }}' -ne ''
        $hasAccount = '${{ secrets.TRUSTED_SIGNING_ACCOUNT }}' -ne ''
        $hasProfile = '${{ secrets.TRUSTED_SIGNING_PROFILE }}' -ne ''
        $shouldSign = $hasEndpoint -and $hasAccount -and $hasProfile
        echo "should_sign=$shouldSign" >> $env:GITHUB_OUTPUT
        if ($shouldSign) {
          Write-Host "Azure Trusted Signing secrets are configured - installer will be signed"
        } else {
          Write-Host "::warning::Azure Trusted Signing secrets not configured - installer will NOT be signed"
        }

    - name: Sign Installer with Azure Trusted Signing
      if: steps.check-signing.outputs.should_sign == 'True'
      uses: azure/trusted-signing-action@v0
      with:
        azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
        azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        endpoint: ${{ secrets.TRUSTED_SIGNING_ENDPOINT }}
        trusted-signing-account-name: ${{ secrets.TRUSTED_SIGNING_ACCOUNT }}
        certificate-profile-name: ${{ secrets.TRUSTED_SIGNING_PROFILE }}
        files-folder: src/HASS.Agent.Installer/bin
        files-folder-filter: exe
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256

    #Upload project artifacts: https://github.com/marketplace/actions/upload-a-build-artifact
    - name: Upload build artifacts (HASS Agent)
      uses: actions/upload-artifact@v4.6.0
      with:
        name: HASS.Agent
        path: "src\\HASS.Agent\\HASS.Agent\\bin\\Publish-x64\\Release"

    - name: Upload build artifacts (HASS Agent Satellite Service)
      uses: actions/upload-artifact@v4.6.0
      with:
        name: HASS.Agent.Satellite.Service
        path: "src\\HASS.Agent\\HASS.Agent.Satellite.Service\\bin\\Publish-x64\\Release"

    - name: Upload build artifacts (HASS Agent Installer)
      uses: actions/upload-artifact@v4.6.0
      with:
        name: HASS.Agent.Installer
        path: "src\\HASS.Agent.Installer\\bin\\HASS.Agent.Installer.exe"
        
    #- name: Debugging artifact paths
    #  run: |
    #    Set-Location src\HASS.Agent
    #    Get-Childitem       

  #draft a release, https://github.com/actions/create-release  
  publish:
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: write
    steps:
    - name: Create directories for Build Artifacts to download
      run: |
        mkdir HASS.Agent
        mkdir HASS.Agent.Satellite.Service
        mkdir HASS.Agent.Installer
        ls -la
    
    - name: Download Build Artifacts (HASS Agent)
      uses: actions/download-artifact@v4.1.8
      with:
        name: HASS.Agent
        path: HASS.Agent

    - name: Download Build Artifacts (HASS Agent Satellite Service)
      uses: actions/download-artifact@v4.1.8
      with:
        name: HASS.Agent.Satellite.Service
        path: HASS.Agent.Satellite.Service

    - name: Download Build Artifacts (HASS Agent Installer)
      uses: actions/download-artifact@v4.1.8
      with:
        name: HASS.Agent.Installer
        path: HASS.Agent.Installer


    - name: Compress HASS Agent directories for manual install
      run: |
        cd HASS.Agent
        ls -la
        zip -r HASS.Agent.zip ./
        cd ../
        cd HASS.Agent.Satellite.Service
        ls -la
        zip -r HASS.Agent.Satellite.Service.zip ./
        
    - name: Create Release and Upload Build Artifacts
      uses: ncipollo/release-action@v1.10.0
      with:
        name: ${{ github.event.inputs.releasetitle }}
        draft: false
        prerelease: ${{ github.event.inputs.prerelease }}
        tag: ${{ github.event.inputs.releasetag }}
        artifacts:
          HASS.Agent/HASS.Agent.zip,HASS.Agent.Satellite.Service/HASS.Agent.Satellite.Service.zip,HASS.Agent.Installer/HASS.Agent.Installer.exe
